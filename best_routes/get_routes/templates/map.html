{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>

    <!-- I use leaflet maps here -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"
      integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css"
      integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="stylesheet" href="{% static '/iconstyle.css' %}">
  </head>
  <body>
    <div id="map" style="height: calc(100svh - 18px); width: calc(100vw - 18px); box-sizing: border-box;"></div>
  </body>
    {% block content %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mapbox-polyline/1.1.1/polyline.min.js"></script>
      <script>
        const map = L.map("map", {
          zoom: 5
        });

        const mytilelayer = L.tileLayer(
          "http://{s}.tile.osm.org/{z}/{x}/{y}.png"
        ).addTo(map);

        const coordinates = {{ coordinates|safe }};
        const myLines = [{
            "type": "LineString",
            coordinates
        }];

        const points1 = {{ logistics.gas_stations|safe }}.map((gas_station) => {
          const { coordinates: coords } = gas_station;

          return {
            "type": "Feature",
            "properties": {
                "show_on_map": true
            },
            "geometry": {
                "type": "Point",
                "coordinates": coords
            }
        }
        })

        console.log(points1)

        const pointPoly = L.geoJSON(points1).addTo(map);

        const features = {{ logistics.gas_stations|safe }}.map((gas_station) => {
          const { info, coordinates: coords } = gas_station;
          const { name, price, gallons_bought } = info

          return {
            "type": "Feature",
            "properties": {
                name,
                price: `$${parseFloat(price.toFixed(2)).toLocaleString()}`,
                gallons: `${gallons_bought.toFixed(0)}Gallons`
              },
            "geometry": {
              "type": "Point",
              "coordinates": coords
            }
          }
        })

        const data_points = {
          "type": "FeatureCollection",
          "name": "test-points-short-named",
          "crs": {
            "type": "name",
            "properties": {
              "name": "urn:ogc:def:crs:OGC:1.3:CRS84"
            }
          },
          features
        };

        const pointLayer = L.geoJSON(null, {
          pointToLayer: function(feature, latlng) {
            var smallIcon = L.DivIcon.extend({
              options: {
                iconSize: [140, 57],
                html: "<div class='icon_cont'>" +
                    "<div class='icon_name'>" +
                      feature.properties.name +
                    "</div>" +
                    "<div class='icon_price'>" +
                      feature.properties.price +
                    "</div>" +
                    "<div>" +
                      feature.properties.gallons +
                    "</div>" +
                  "</div>"
              }
            });
            return L.marker({ ...latlng, lng: latlng.lng + 0.007 }, {icon: new smallIcon()}).setOpacity(0.7);
          }      
        });
        pointLayer.addData(data_points);
        map.addLayer(pointLayer);

        {% comment %} let poly_coordinates = polyline.decode("{{ geometry }}");
        const poly =  L.polyline(poly_coordinates, { color: "#2a3561", weight: 5 }).addTo(map);
        map.addLayer(poly); {% endcomment %}

        {% comment %} coords = coordinates.map((c) => [c[1], c[0]])
        var polygon = L.polygon(coords, {color: 'red', fillOpacity: 0}).addTo(map); {% endcomment %}

        // zoom the map to the polygon
        // map.fitBounds(polygon.getBounds());

        const poly2 = L.geoJSON(myLines, {
          style: function (geoJsonFeature) {
            return {
              opacity: 1,
              strokeColor: "black",
              // stroke: false
            };
          }
        }).addTo(map);
        map.fitBounds(poly2.getBounds());

        {% comment %} const way_points = coordinates.map((c) => L.latLng(c[1], c[0]))
        L.Routing({
          waypoints: way_points,
          routeWhileDragging: true
        }).addTo(map); {% endcomment %}
      </script>
    {% endblock content %}
</html>